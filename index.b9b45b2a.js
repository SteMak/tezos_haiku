var e="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof self?self:"undefined"!=typeof window?window:"undefined"!=typeof global?global:{},t={},a={},n=e.parcelRequirecef0;null==n&&((n=function(e){if(e in t)return t[e].exports;if(e in a){var n=a[e];delete a[e];var o={id:e,exports:{}};return t[e]=o,n.call(o.exports,o,o.exports),o.exports}var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}).register=function(e,t){a[e]=t},e.parcelRequirecef0=n);var o=n("3veC1"),r=n("7zxwo");n("45MeG");const c=new o.TezosToolkit(rpc_addr),d=new r.BeaconWallet({name:"Tezos Haiku"});c.setWalletProvider(d),c.contract.at(contract_addr).then((e=>e.storage().then((e=>{s(e),check_wallet(),data_loaded=!0,l()})))).catch((e=>console.log(`Error: ${JSON.stringify(e,null,2)}`))),check_wallet=async()=>{const e=await d.client.getActiveAccount();e?user_addr=e.address:document.getElementById("buttons_preview").innerHTML+='<a class="btn btn_secondary right_down_space" onclick="connect_wallet()">Connect wallet</a>'},connect_wallet=async()=>{const e=await d.client.getActiveAccount();if(e)user_addr=e.address;else{const e=await d.client.requestPermissions({network:{type:network,rpcUrl:rpc_addr}});user_addr=e.address}document.getElementById("buttons_preview").lastChild.remove()},disconnect_wallet=async()=>await d.clearActiveAccount();const s=e=>{data.tokens=[],data.owners=[];for(const[t,a]of e.token.valueMap){a.id=Number(t.slice(1,-1)),a.amount=Number(a.amount),a.state=Number(a.state),a.cnfrm_at=new Date(a.cnfrm_at),a.crted_at=new Date(a.crted_at),a.text_color=Number(a.text_color);const e={b:a.text_color%256};e.g=(a.text_color-e.b)/256%256,e.r=((a.text_color-e.b)/256-e.g)/256%256,a.back_color=Number(a.back_color);const n={b:a.back_color%256};n.g=(a.back_color-n.b)/256%256,n.r=((a.back_color-n.b)/256-n.g)/256%256,a.image=`<svg class="" width="338px" height="225px" role="img" focusable="false">\n    <rect width="100%" height="100%" fill="rgb(${n.r},${n.g},${n.b})" rx="0.25rem" ry="0.25rem"></rect>\n    <text y="20%" fill="white" font-size="1.2em">\n      ${a.content.split("\n").reduce(((t,a)=>t+`<tspan x="10%" dy="1.6em" fill="rgb(${e.r},${e.g},${e.b})">${a}</tspan>`),"")}\n    </text>\n  </svg>`,data.tokens.push(a)}for(const[t,a]of e.ledger.valueMap){const e=JSON.parse(t);a.token_id=Number(e[1]),a.owner=e[0],a.count=Number(a.count),a.for_sale=Number(a.for_sale),a.price=Number(a.price),data.owners.push(a)}},l=()=>{if(dom_loaded&&data_loaded){console.log(data.tokens),console.log(data.owners);for(const e of data.tokens.filter((e=>1==e.state)).sort(((e,t)=>t.cnfrm_at-e.cnfrm_at))){const t=data.owners.filter((t=>t.token_id==e.id)).reduce(((e,t)=>e>t.price&&t.for_sale>0?t.price:e),1/0);document.getElementById("tokens").innerHTML+=`<div class="card token" onclick="buy_open(${e.id})">\n      ${e.image}\n      <div class="card-body">\n        <p class="card-text">Haiku #${e.id} written by <a style="font-family:monospace; font-size: initial;">${e.creator}</a></p>\n        <b class="card-text">${t!==1/0?`Price starts from <a style="font-family:monospace;">${t/1e6}tz</a>`:"Not for sale :("}</b>\n        <p></p>\n        <div class="d-flex justify-content-between align-items-center">\n          <button type="button" id="buy_button-${e.id}" class="btn btn-sm btn-outline-secondary buy_button">More</button>\n          <small class="text-muted">${e.cnfrm_at.toGMTString().split(", ")[1].slice(0,-7)}</small>\n        </div>\n      </div>\n    </div>`}}};buy_open=async e=>{const t=data.tokens[e];data.buy_cache=data.owners.filter((e=>e.token_id==t.id&&e.for_sale>0)).filter((e=>e.owner!=user_addr)).sort(((e,t)=>e.price-t.price));const a=data.buy_cache.reduce(((e,t)=>e+ +t.for_sale),0);document.getElementById("buy_popup").innerHTML=`<section id="buy_popup_overlay" class="overlay__">\n    <div class="container__">\n      <h1 class="fw-light buy_header">Buy Haiku #${t.id}</h1>\n      <div class="card token buy_image">\n        ${t.image}\n      </div>\n      <div class="buy_body">\n        <div class="card buy_card">Creator: ${t.creator.slice(0,7)}...${t.creator.slice(-7)}</div>\n        <div class="card buy_card">Created at: ${t.crted_at.toGMTString().split(", ")[1]}</div>\n        <div class="card buy_card">Total supply: ${t.amount}</div>\n        ${user_addr?`<div class="card buy_card">You own: ${data.owners.filter((e=>e.owner==user_addr&&e.token_id==t.id)).reduce(((e,t)=>e+t.count),0)}</div>`:""}\n        ${data.buy_cache.length?`\n          <div class="buy_inputs">\n            <label for="buy_amount" class="buy_label">Choose how many items you want to buy</label>\n            <input type="range" class="form_range" min="1" max="${a}" value="1" step="1" id="buy_amount">\n          </div>\n          <div class="card buy_card" id="buy_samt">Selected amount: 1</div>\n          <div class="card buy_card" id="buy_cost">Total price: ${data.buy_cache[0].price/1e6}tz</div>\n          <p class="buy_note">Note: each item of haiku has its own price. But our alghorithm include the cheapest ones in the total price, so you shouldn't worry if price of five items is bigger than price of the first multiplied by five.</p>\n        `:""}\n        <div class="btn-group buy_btn_group" role="group">\n          <button type="button" onclick="buy_close()" class="btn btn_secondary buy_cfrm_button">CANCEL</button>\n          ${data.buy_cache.length&&user_addr?`<button type="button" id="buy_cfrm-${e}" class="btn btn_primary buy_cfrm_button">BUY</button>`:`<button type="button" id="buy_cfrm-${e}" class="btn btn_primary buy_cfrm_button" disabled>BUY</button>`}\n        </div>\n        <p class="buy_note" id="note_result">${user_addr?"":"Please, connect your wallet to buy haikus"}</p>\n      </div>\n    </div>\n  </section>`},buy_close=()=>{document.getElementById("buy_popup").innerHTML="",data.buy_cache=void 0};document.addEventListener("DOMContentLoaded",(()=>{dom_loaded=!0,l()})),document.addEventListener("click",(e=>{"buy_popup_overlay"==e.target.id&&buy_close();const t=e.target.id.split("-");if("buy_cfrm"==t[0]){const e=[];let a=document.getElementById("buy_amount").value,n=0;for(let t=0;a>0;t++)a>=data.buy_cache[t].for_sale?(n+=data.buy_cache[t].price*data.buy_cache[t].for_sale,a-=data.buy_cache[t].for_sale,e.push({seller:data.buy_cache[t].owner,buy_amount:data.buy_cache[t].for_sale})):(n+=data.buy_cache[t].price*a,e.push({seller:data.buy_cache[t].owner,buy_amount:a}),a=0);(async(e,t,a)=>{document.getElementById(`buy_cfrm-${e}`).disabled=!0,document.getElementById("note_result").innerHTML="Please, confirm transaction in your wallet",contract=contract||await c.wallet.at(contract_addr);try{await contract.methods.token_buy(Number(e),a).send({amount:t,mutez:!0}),document.getElementById("note_result").innerHTML="Your request is in work. Wait some and update page to view changes."}catch(t){"Aborted"==t.title?(document.getElementById("note_result").innerHTML="Please, try again and confirm transaction in your wallet",document.getElementById(`buy_cfrm-${e}`).disabled=!1):document.getElementById("note_result").innerHTML="Something went wrong, please update page and try again",console.log("The contract call failed and the following error was returned:",t)}})(t[1],n,e)}})),document.addEventListener("input",(e=>{if("buy_amount"==e.target.id){let t=e.target.value,a=0;for(let e=0;t>0;e++)t>=data.buy_cache[e].for_sale?(a+=data.buy_cache[e].price*data.buy_cache[e].for_sale,t-=data.buy_cache[e].for_sale):(a+=data.buy_cache[e].price*t,t=0);document.getElementById("buy_cost").innerHTML=`Total price: ${a/1e6}tz`,document.getElementById("buy_samt").innerHTML=`Selected amount: ${e.target.value}`}}));
//# sourceMappingURL=index.b9b45b2a.js.map
