{"mappings":"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","sources":["src/js/index.js"],"sourcesContent":["import { TezosToolkit } from \"@taquito/taquito\";\nimport { BeaconWallet } from \"@taquito/beacon-wallet\";\nimport { TezosOperationType } from \"@airgap/beacon-sdk\";\n\nconst Tezos = new TezosToolkit(rpc_addr);\nconst Wallet = new BeaconWallet({ name: \"Tezos Haiku\" });\nTezos.setWalletProvider(Wallet);\n\nTezos.contract.at(contract_addr)\n  .then(contract => {\n    return contract.storage()\n      .then(storage => {\n        assign_data(storage)\n        check_wallet()\n        data_loaded = true\n        main_start()\n      })\n  })\n  .catch(error => console.log(`Error: ${JSON.stringify(error, null, 2)}`));\n\ncheck_wallet = async () => {\n  const activeAccount = await Wallet.client.getActiveAccount();\n  if (!activeAccount) {\n    document.getElementById('buttons_preview').innerHTML += '<a class=\"btn btn_secondary right_down_space\" onclick=\"connect_wallet()\">Connect wallet</a>'\n  } else {\n    user_addr = activeAccount.address;\n  }\n}\n\nconnect_wallet = async () => {\n  const activeAccount = await Wallet.client.getActiveAccount();\n  if (!activeAccount) {\n    const permissions = await Wallet.client.requestPermissions({\n      network: {\n        type: network,\n        rpcUrl: rpc_addr,\n      },\n    });\n    user_addr = permissions.address;\n  } else {\n    user_addr = activeAccount.address;\n  }\n\n  document.getElementById('buttons_preview').lastChild.remove()\n}\n\ndisconnect_wallet = async () => await Wallet.clearActiveAccount()\n\nconst assign_data = (storage) => {\n  data.tokens = []\n  data.owners = []\n\n  for (const [key, value] of storage.token.valueMap) {\n    value.id = Number(key.slice(1, -1))\n    value.amount = Number(value.amount)\n    value.state = Number(value.state)\n    value.cnfrm_at = new Date(value.cnfrm_at)\n    value.crted_at = new Date(value.crted_at)\n    value.text_color = Number(value.text_color)\n    const c_t = { b: value.text_color % 256 }\n    c_t.g = (value.text_color - c_t.b) / 256 % 256\n    c_t.r = ((value.text_color - c_t.b) / 256 - c_t.g) / 256 % 256\n    value.back_color = Number(value.back_color)\n    const c_b = { b: value.back_color % 256 }\n    c_b.g = (value.back_color - c_b.b) / 256 % 256\n    c_b.r = ((value.back_color - c_b.b) / 256 - c_b.g) / 256 % 256\n    value.image = `<svg class=\"\" width=\"338px\" height=\"225px\" role=\"img\" focusable=\"false\">\n    <rect width=\"100%\" height=\"100%\" fill=\"rgb(${c_b.r},${c_b.g},${c_b.b})\" rx=\"0.25rem\" ry=\"0.25rem\"></rect>\n    <text y=\"20%\" fill=\"white\" font-size=\"1.2em\">\n      ${value.content.split('\\n').reduce((a, c) => a + `<tspan x=\"10%\" dy=\"1.6em\" fill=\"rgb(${c_t.r},${c_t.g},${c_t.b})\">${c}</tspan>`, \"\")}\n    </text>\n  </svg>`\n    data.tokens.push(value)\n  }\n  for (const [s_key, value] of storage.ledger.valueMap) {\n    const key = JSON.parse(s_key)\n    value.token_id = Number(key[1])\n    value.owner = key[0]\n    value.count = Number(value.count)\n    value.for_sale = Number(value.for_sale)\n    value.price = Number(value.price)\n    data.owners.push(value)\n  }\n}\n\nconst main_start = () => {\n  if (!dom_loaded || !data_loaded) return\n\n  console.log(data.tokens)\n  console.log(data.owners)\n\n  for (const t of data.tokens.filter(c => c.state == 1).sort((a, b) => b.cnfrm_at - a.cnfrm_at)) {\n    const min_price = data.owners.filter(c => c.token_id == t.id).reduce((a, c) => a > c.price && c.for_sale > 0 ? c.price : a, Infinity)\n    document.getElementById(\"tokens\").innerHTML += `<div class=\"card token\" onclick=\"buy_open(${t.id})\">\n      ${t.image}\n      <div class=\"card-body\">\n        <p class=\"card-text\">Haiku #${t.id} written by <a style=\"font-family:monospace; font-size: initial;\">${t.creator}</a></p>\n        <b class=\"card-text\">${min_price !== Infinity ? `Price starts from <a style=\"font-family:monospace;\">${min_price / 1000000}tz</a>` : `Not for sale :(`}</b>\n        <p></p>\n        <div class=\"d-flex justify-content-between align-items-center\">\n          <button type=\"button\" id=\"buy_button-${t.id}\" class=\"btn btn-sm btn-outline-secondary buy_button\">More</button>\n          <small class=\"text-muted\">${t.cnfrm_at.toGMTString().split(', ')[1].slice(0, -7)}</small>\n        </div>\n      </div>\n    </div>`\n  }\n}\n\nbuy_open = async (id) => {\n  const t = data.tokens[id]\n  data.buy_cache = data.owners.filter(c => c.token_id == t.id && c.for_sale > 0).filter(c => c.owner != user_addr).sort((a, b) => a.price - b.price)\n  const max_amount = data.buy_cache.reduce((a, c) => a + +c.for_sale, 0)\n  document.getElementById('buy_popup').innerHTML = `<section id=\"buy_popup_overlay\" class=\"overlay__\">\n    <div class=\"container__\">\n      <h1 class=\"fw-light buy_header\">Buy Haiku #${t.id}</h1>\n      <div class=\"card token buy_image\">\n        ${t.image}\n      </div>\n      <div class=\"buy_body\">\n        <div class=\"card buy_card\">Creator: ${t.creator == user_addr ? `<a class=\"alien\" href=\"${account_link}\" target=\"_blank\">you</a>` : `<a class=\"alien\" href=\"${alien_link}?address=${t.creator}\" target=\"_blank\">${t.creator.slice(0, 7)}...${t.creator.slice(-7)}</a>`}</div>\n        <div class=\"card buy_card\">Created at: ${t.crted_at.toGMTString().split(', ')[1]}</div>\n        <div class=\"card buy_card\">Total supply: ${t.amount}</div>\n        ${user_addr ? `<div class=\"card buy_card\">You own: ${data.owners.filter(c => c.owner == user_addr && c.token_id == t.id).reduce((a, c) => a + c.count, 0)}</div>` : \"\"}\n        ${data.buy_cache.length ? `\n          <div class=\"buy_inputs\">\n            <label for=\"buy_amount\" class=\"buy_label\">Choose how many items you want to buy</label>\n            <input type=\"range\" class=\"form_range\" min=\"1\" max=\"${max_amount}\" value=\"1\" step=\"1\" id=\"buy_amount\">\n          </div>\n          <div class=\"card buy_card\" id=\"buy_samt\">Selected amount: 1</div>\n          <div class=\"card buy_card\" id=\"buy_cost\">Total price: ${data.buy_cache[0].price / 1000000}tz</div>\n          <p class=\"buy_note\">Note: each item of haiku has its own price. But our alghorithm include the cheapest ones in the total price, so you shouldn't worry if price of five items is bigger than price of the first multiplied by five.</p>\n        `: ''}\n        <div class=\"btn-group buy_btn_group\" role=\"group\">\n          <button type=\"button\" onclick=\"buy_close()\" class=\"btn btn_secondary buy_cfrm_button\">CANCEL</button>\n          ${data.buy_cache.length && user_addr ? `<button type=\"button\" id=\"buy_cfrm-${id}\" class=\"btn btn_primary buy_cfrm_button\">BUY</button>` : `<button type=\"button\" id=\"buy_cfrm-${id}\" class=\"btn btn_primary buy_cfrm_button\" disabled>BUY</button>`}\n        </div>\n        <p class=\"buy_note\" id=\"note_result\">${!user_addr ? 'Please, connect your wallet to buy haikus' : ''}</p>\n      </div>\n    </div>\n  </section>`\n}\nbuy_close = () => {\n  document.getElementById('buy_popup').innerHTML = ''\n  data.buy_cache = undefined\n}\n\nconst token_buy = async (id, pay, sellers) => {\n  document.getElementById(`buy_cfrm-${id}`).disabled = true\n  document.getElementById('note_result').innerHTML = 'Please, confirm transaction in your wallet'\n  contract = contract ? contract : await Tezos.wallet.at(contract_addr);\n  try {\n    const result = await contract.methods.token_buy(Number(id), sellers).send({ amount: pay, mutez: true });\n    document.getElementById('note_result').innerHTML = 'Your request is in work. Wait some and update page to view changes.'\n  } catch (error) {\n    if (error.title == 'Aborted') {\n      document.getElementById('note_result').innerHTML = 'Please, try again and confirm transaction in your wallet'\n      document.getElementById(`buy_cfrm-${id}`).disabled = false\n    } else {\n      document.getElementById('note_result').innerHTML = 'Something went wrong, please update page and try again'\n    }\n    console.log(`The contract call failed and the following error was returned:`, error);\n  }\n}\n\ndocument.addEventListener(\"DOMContentLoaded\", () => { dom_loaded = true; main_start() })\ndocument.addEventListener('click', e => {\n  if (e.target.id == 'buy_popup_overlay') buy_close()\n  const id = e.target.id.split('-')\n  if (id[0] == 'buy_cfrm') {\n    const sellers = []\n    let a = document.getElementById('buy_amount').value\n    let r = 0\n    for (let i = 0; a > 0; i++) {\n      if (a >= data.buy_cache[i].for_sale) {\n        r += data.buy_cache[i].price * data.buy_cache[i].for_sale\n        a -= data.buy_cache[i].for_sale\n        sellers.push({ seller: data.buy_cache[i].owner, buy_amount: data.buy_cache[i].for_sale })\n      } else {\n        r += data.buy_cache[i].price * a\n        sellers.push({ seller: data.buy_cache[i].owner, buy_amount: a })\n        a = 0\n      }\n    }\n    token_buy(id[1], r, sellers)\n  }\n})\ndocument.addEventListener('input', e => {\n  if (e.target.id == 'buy_amount') {\n    let a = e.target.value\n    let r = 0\n    for (let i = 0; a > 0; i++) {\n      if (a >= data.buy_cache[i].for_sale) {\n        r += data.buy_cache[i].price * data.buy_cache[i].for_sale\n        a -= data.buy_cache[i].for_sale\n      } else {\n        r += data.buy_cache[i].price * a\n        a = 0\n      }\n    }\n    document.getElementById('buy_cost').innerHTML = `Total price: ${r / 1000000}tz`\n    document.getElementById('buy_samt').innerHTML = `Selected amount: ${e.target.value}`\n  }\n})\n"],"names":["_taquito","require","_beaconWallet","Tezos","TezosToolkit","rpc_addr","Wallet","BeaconWallet","name","setWalletProvider","contract","at","contract_addr","then","storage","assign_data","check_wallet","data_loaded","main_start","catch","error","console","log","JSON","stringify","async","activeAccount","client","getActiveAccount","user_addr","address","document","getElementById","innerHTML","connect_wallet","permissions","requestPermissions","network","type","rpcUrl","lastChild","remove","disconnect_wallet","clearActiveAccount","data","tokens","owners","key","value","token","valueMap","id","Number","slice","amount","state","cnfrm_at","Date","crted_at","text_color","c_t","b","g","r","back_color","c_b","image","content","split","reduce","a","c","push","s_key","value1","ledger","key1","parse","token_id","owner","count","for_sale","price","dom_loaded","t","filter","sort","min_price","Infinity","creator","toGMTString","buy_open","buy_cache","max_amount","account_link","alien_link","length","buy_close","undefined","addEventListener","e","target","sellers","i","seller","buy_amount","pay","disabled","wallet","methods","token_buy","send","mutez","title"],"version":3,"file":"index.9e3c5618.js.map"}